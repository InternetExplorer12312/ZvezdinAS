# Отчет по лабораторной работе №1
# Архитектура СУБД и конфигурации

**Дата:** 2025-10-05  
**Семестр:** 4 курс 1 полугодие – 7 семестр  
**Группа:** ПИЖ-б-о-22-1  
**Дисциплина:** Администрирование баз данных  
**Студент:** Звездин Алексей Сергеевич 

## Цель работы
Изучить базовые компоненты архитектуры PostgreSQL (процессы и память) и получить практические навыки управления конфигурационными параметрами сервера на разных уровнях (экземпляр, сеанс). Освоить работу с основными и дополнительными файлами конфигурации, а также с представлениями `pg_settings` и `pg_file_settings`. 

## Практическая часть

### Часть 1. Исследование параметров и файлов конфигурации

**Выполненные задачи:**   
1. Подключился к серверу с помощью `psql`. Определил расположение основного файла конфигурации (postgresql.conf) с помощью команды `SHOW config_file;`.  

2. Изучил представление `pg_settings`. Нашёл параметры, для изменения которых требуется перезагрузка сервера (`context = 'postmaster'`). Нашёл 3 параметра с контекстом sighup и user.  

3. Изучил представление `pg_file_settings`. Определил, из каких файлов и с какими значениями были считаны текущие настройки параметров `shared_buffers` и `work_mem`.

**Выполненные команды и результат**

**Задача 1:**
```bash
sudo -u postgres psql
```
```sql
SHOW config_file;
```

**Результат:**
```text
psql (16.10 (Ubuntu 16.10-1.pgdg24.04+1))
Type "help" for help.

postgres=# SHOW config_file;
               config_file               
-----------------------------------------
 /etc/postgresql/16/main/postgresql.conf
(1 row)
```


**Задача 2:**
```sql
postgres=# SELECT name, setting, context 
FROM pg_settings 
WHERE context = 'postmaster'
LIMIT 3;
```

```sql
postgres=# SELECT name, setting, context 
FROM pg_settings 
WHERE context = 'sighup'
LIMIT 3;
```

```sql
postgres=# SELECT name, setting, context 
FROM pg_settings 
WHERE context = 'user'
LIMIT 3;
```

**Результат:**
```text
           name            |  setting  |  context   
---------------------------+-----------+------------
 archive_mode              | off       | postmaster
 autovacuum_freeze_max_age | 200000000 | postmaster
 autovacuum_max_workers    | 3         | postmaster
(3 rows)
```

```text
          name           |  setting   | context 
-------------------------+------------+---------
 archive_cleanup_command |            | sighup
 archive_command         | (disabled) | sighup
 archive_library         |            | sighup
(3 rows)
```

```text
        name         | setting | context 
---------------------+---------+---------
 application_name    | psql    | user
 array_nulls         | on      | user
 backend_flush_after | 0       | user
(3 rows)
```

**Задача 3:**
```sql
postgres=# SELECT *
FROM pg_file_settings
WHERE name IN ('shared_buffers','work_mem');
```

**Результат:**
```text
               sourcefile                | sourceline | seqno |      name      | setting | applied | error 
-----------------------------------------+------------+-------+----------------+---------+---------+-------
 /etc/postgresql/16/main/postgresql.conf |        130 |    11 | shared_buffers | 128MB   | t       | 
(1 row)
```

### Часть 2. Управление параметрами на уровне экземпляра
**Выполненные задачи:**   
1.	Используя команду `ALTER SYSTEM`, установил для параметра `work_mem` новое значение. Убедился, что изменение записалось в файл `postgresql.auto.conf` (использовал функцию `pg_read_file`). Применил изменение, перечитав конфигурацию (`SELECT pg_reload_conf();`). Проверил новое значение параметра и его источник в `pg_settings;`.  

**Выполненные команды и результат**

**Задача 1:**
```sql
postgres=# ALTER SYSTEM SET work_mem = '8MB';
postgres=# SELECT pg_read_file('postgresql.auto.conf');
```

```sql
SELECT pg_reload_conf();
```

```sql
SELECT name, setting, unit, source, sourcefile 
FROM pg_settings 
WHERE name = 'work_mem';
```


**Результат:**
```text
ALTER SYSTEM
postgres=# SELECT pg_read_file('postgresql.auto.conf');
                     pg_read_file                      
-------------------------------------------------------
 # Do not edit this file manually!                    +
 # It will be overwritten by the ALTER SYSTEM command.+
 work_mem = '8MB'                                     +
 
(1 row)
```

```text
 pg_reload_conf 
----------------
 t
(1 row)
```

```text
   name   | setting | unit |       source       |                    sourcefile                    
----------+---------+------+--------------------+--------------------------------------------------
 work_mem | 8192    | kB   | configuration file | /var/lib/postgresql/16/main/postgresql.auto.conf
(1 row)
```

##Ответы на контрольные вопросы

**Объяснение разницы между контекстами параметров postmaster, sighup и user.**

### Postmaster контекст
- Требует полного перезапуска кластера PostgreSQL
- Изменения применяются только после перезагрузки сервера
- Параметры читаются при старте основного процесса postmaster
- Относятся к фундаментальным настройкам СУБД

### SIGHUP контекст
- Требует перечитывания конфигурационных файлов
- Применяется через сигнал SIGHUP или функцию pg_reload_conf()
- Новые подключения получают обновленные параметры
- Существующие сеансы сохраняют предыдущие значения

### User контекст
- Может быть изменен в рамках текущего сеанса
- SET - действует до конца сеанса
- SET LOCAL - действует до конца текущей транзакции
- Не требует перезагрузки сервера

**Объяснение разницы между применением изменений через ALTER SYSTEM и через SET/SET LOCAL.**
### ALTER SYSTEM
- Вносит изменения в postgresql.auto.conf
- Изменения сохраняются постоянно
- Требует соответствующего контекста для активации
- Имеет приоритет над основным конфигурационным файлом

### SET / SET LOCAL
- SET - изменение на время сеанса
- SET LOCAL - изменение на время транзакции
- Изменения являются временными
- Не требуют прав суперпользователя для некоторых параметров

**Описание процедуры поиска и исправления ошибки в конфигурационном файле.**
### Обнаружение проблемы
- Анализ логов PostgreSQL
- Проверка статуса сервера
- Мониторинг системных журналов

### Локализация ошибки
- Проверка синтаксиса конфигурационных файлов
- Валидация путей и разрешений
- Проверка допустимости значений параметров

### Диагностика
- Использование SHOW для проверки параметров
- Анализ pg_settings

### Исправление
- Корректировка конфигурационных файлов
- Использование ALTER SYSTEM для безопасного изменения
- Поэтапное применение изменений

### Верификация
- Тестирование через перечитывание конфигурации
- Проверка функциональности

### Восстановление
- Откат к резервной копии конфигурации
- Использование минимальной конфигурации
- Постепенное возвращение настроек

## Вывод
В процессе лабораторной работы я изучил базовые компоненты архитектуры PostgreSQL (процессы, память) и получил практические навыки управления конфигурационными параметрами сервера на разных уровнях (экземпляр, сеанс). Также освоил работу с основными и дополнительными файлами конфигурации, а также с представлениями pg_settings и pg_file_settings.